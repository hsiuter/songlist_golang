<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>歌單列表</title>
    <link rel="stylesheet" href="/assets/css/songlist.css">
</head>

<body>
    <!-- <h1>我的歌單</h1> -->
    <div class="container">
        <div class="intro_container">
            <div id="avatar">
                <img id="avatarImage" src="" alt="用户头像">
            </div>
            <div class="intro">栗安 LiAN</div>
            <div class="intro">和她的栗子小曲</div>
            <div class="intro">點歌名複製</div>
        </div>
        <div class="songlist_container">
            <div class="button_container">
                <button id="chineseButton">中文</button>
                <button id="japaneseButton">日文</button>
                <button id="englishButton">英文</button>
            </div>
            <input type="text" id="searchBox" placeholder="搜索歌名...">
            <div class="table_container scrollbar">
                <table id="songlistTable">
                    <thead>
                        <tr>
                            <th>歌單名稱</th>
                            <th>歌手</th>
                            <th>語言</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 歌單數據將在這裡顯示 -->
                    </tbody>
                </table>
            </div>

        </div>

    </div>




    <script>
        const url = window.location.href;
        const usernameRegex = /\/([^/]+)\/songlistpage/;
        const match = url.match(usernameRegex);

        if (match && match[1]) {
            const username = match[1];
            // 现在你有了用户名，可以将它发送到后端以获取userID和头像路径
            fetch(`/get-userid-and-avatar?username=${username}`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.userID && data.avatarPath) {
                        const avatarPath = data.avatarPath;
                        // 在这里使用头像路径，例如设置用户头像的<img>标签的src属性
                        const avatarImage = document.getElementById('avatarImage');
                        console.log(avatarPath);
                        avatarImage.src = avatarPath;
                    } else {
                        console.error("UserID or avatarPath not found in response");
                    }
                })
                .catch(error => console.error('Error:', error));
        } else {
            console.error("Username not found in URL");
        }


        // 按钮元素
        const chineseButton = document.getElementById('chineseButton');
        const japaneseButton = document.getElementById('japaneseButton');
        const englishButton = document.getElementById('englishButton');

        // 按钮事件监听器
        chineseButton.addEventListener('click', () => toggleLanguageFilter('中文'));
        japaneseButton.addEventListener('click', () => toggleLanguageFilter('日文'));
        englishButton.addEventListener('click', () => toggleLanguageFilter('英文'));

        let selectedLanguage = '';

        function toggleLanguageFilter(language) {
            selectedLanguage = (selectedLanguage === language) ? '' : language;
            updateButtons();
            searchAndFilterSongs();
        }

        function updateButtons() {
            // 根据筛选状态更新按钮样式
            chineseButton.classList.toggle('button-selected', selectedLanguage === '中文');
            japaneseButton.classList.toggle('button-selected', selectedLanguage === '日文');
            englishButton.classList.toggle('button-selected', selectedLanguage === '英文');
        }

        function updateButtons() {
            // 更新按钮样式
            chineseButton.classList.toggle('selected', selectedLanguage === '中文');
            japaneseButton.classList.toggle('selected', selectedLanguage === '日文');
            englishButton.classList.toggle('selected', selectedLanguage === '英文');
        }

        // 添加搜索事件监听器
        document.getElementById('searchBox').addEventListener('input', function (e) {
            searchSong(e.target.value);
        });

        // 定义全局变量来存储歌单数据
        let songlistData = [];

        // 定义搜索歌曲的函数
        function searchAndFilterSongs() {
            const searchText = document.getElementById('searchBox').value;
            let filteredData = songlistData;

            if (selectedLanguage) {
                filteredData = filteredData.filter(songlist => songlist.Language === selectedLanguage);
            }

            if (searchText) {
                filteredData = filteredData.filter(songlist => songlist.Name.includes(searchText));
            }

            displaySongs(filteredData);
        }

        // 修改现有的搜索事件监听器
        document.getElementById('searchBox').addEventListener('input', searchAndFilterSongs);
        const username = match[1];
        console.log(username);
        // 修改原来的数据获取方法，以存储数据到全局变量
        fetch('/display-songlist', {
            method: 'POST',
            // username傳到後端
            body: JSON.stringify({ username: username }), // 将用户名作为JSON数据发送到后端
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                songlistData = data; // 存储数据到全局变量
                displaySongs(data); // 显示数据
            })
            .catch(error => console.error('Error:', error));

        // 定义一个新函数来显示歌单
        // 定义一个新函数来显示歌单
        function displaySongs(data) {
            const tableBody = document.getElementById('songlistTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // 清空现有数据
            data.forEach(songlist => {
                let row = tableBody.insertRow();
                let songNameCell = row.insertCell(0);
                songNameCell.innerHTML = songlist.Name;
                songNameCell.classList.add('clickable-song-name'); // 添加class以便于添加事件监听器
                row.insertCell(1).innerHTML = songlist.Singer;
                row.insertCell(2).innerHTML = songlist.Language;
                row.insertCell(3).innerHTML = songlist.Description;

                // 為歌曲名添加點擊事件
                songNameCell.addEventListener('click', () => copySongNameToClipboard(songlist.Name));
            });
        }

        // 定义一个函数来处理歌曲名的点击事件
        function copySongNameToClipboard(songName) {
            const textToCopy = `我可以點歌嗎！我想要聽${songName}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('已複製到剪貼簿: ' + textToCopy); // 可以選擇是否顯示提示
            }).catch(err => {
                console.error('無法複製歌曲名稱', err);
            });
        }
    </script>

</body>

</html>